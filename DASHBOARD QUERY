WITH CUSTOMER_REG AS (
    SELECT
        SR_ID AS CUSTOMER_ID,
        REG_NAME AS CUSTOMER_NAME
    FROM
        AB_SETUP_REGISTRATION SR
    WHERE
        REG_TYPE = 'CUSTOMER REGISTRATION'
),
SALE_ORDER_CUSTOMERS AS (
    SELECT
        UAU.USER_NAME AS SALE_OFFICER,
        COUNT(DISTINCT SI.CUSTOMER_ID) AS CUSTOMER_COUNT,
        SUM(NVL(SIDD.QTY,0)) AS TOTAL_QTY
    FROM
        AB_SALE_INFO SI
        LEFT JOIN AB_UM_APPLICATION_USERS UAU ON UAU.USER_ID = SI.EMP_ID
        LEFT JOIN CUSTOMER_REG CR ON CR.CUSTOMER_ID = SI.CUSTOMER_ID
        LEFT JOIN AB_LOOKUP_DETAIL LD ON LD.DET_ID = SI.FREIGHT_TYPE_ID
        LEFT JOIN AB_SALE_INFO_DET SIDD ON SIDD.SALE_ID = SI.SALE_ID  
            AND LD.LOOKUP_ID = 022
            AND SI.ORG_ID = :GV_ORG_ID
    WHERE
        SALE_TYPE = 'SALE ORDER'
    GROUP BY
        UAU.USER_NAME
),
CUSTOMER_ASSIGN_CUSTOMERS AS (
    SELECT
        UAU.USER_NAME AS SALE_OFFICER,
        COUNT(DISTINCT ASID.CUSTOMER_ID) AS CUSTOMER_COUNT
    FROM 
        AB_SALE_INFO_DET ASID
    JOIN 
        AB_SALE_INFO SI ON SI.SALE_ID = ASID.SALE_ID
    JOIN 
        AB_UM_APPLICATION_USERS UAU ON UAU.USER_ID = SI.EMP_ID
    LEFT JOIN  
        AB_SETUP_REGISTRATION ASR ON ASID.CUSTOMER_ID = ASR.SR_ID
    WHERE 
        ASID.DET_SALE_TYPE = 'CUSTOMER ASSIGN DET'
        AND SI.ORG_ID = :GV_ORG_ID
        AND ASID.STATUS = 'Y'
    GROUP BY 
        UAU.USER_NAME
),
TOTAL_CALL_TODAY AS (
    SELECT 
        UAU.USER_NAME AS SALE_OFFICER,
        COUNT(*) AS TOTAL_CALLS 
    FROM 
        AB_SALE_INFO_DET ASID
    JOIN 
        AB_SALE_INFO SI ON SI.SALE_ID = ASID.SALE_ID
    JOIN 
        AB_UM_APPLICATION_USERS UAU ON UAU.USER_ID = SI.EMP_ID
    WHERE 
        TO_CHAR(ASID.UPDATED_ON, 'DD-MON-YYYY') = TO_CHAR(SYSDATE, 'DD-MON-YYYY')
        AND SI.ORG_ID = :GV_ORG_ID
    GROUP BY 
        UAU.USER_NAME
)
SELECT
    COALESCE(SO.SALE_OFFICER, CA.SALE_OFFICER, TC.SALE_OFFICER) AS SALE_OFFICER,
    NVL(SO.CUSTOMER_COUNT, 0) AS SALE_ORDER_COUNT,
    NVL(CA.CUSTOMER_COUNT, 0) AS CUSTOMER_ASSIGN_COUNT,
    NVL(SO.CUSTOMER_COUNT, 0) + NVL(CA.CUSTOMER_COUNT, 0) AS TOTAL_CUSTOMER_COUNT,
    NVL(SO.TOTAL_QTY, 0) AS QTY,
    NVL(TC.TOTAL_CALLS, 0) AS TOTAL_CALL_TODAY
FROM
    SALE_ORDER_CUSTOMERS SO
FULL OUTER JOIN CUSTOMER_ASSIGN_CUSTOMERS CA ON SO.SALE_OFFICER = CA.SALE_OFFICER
FULL OUTER JOIN TOTAL_CALL_TODAY TC ON COALESCE(SO.SALE_OFFICER, CA.SALE_OFFICER) = TC.SALE_OFFICER
ORDER BY
    TOTAL_CUSTOMER_COUNT DESC;
